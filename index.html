addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  const urls = [
    { url: "https://blog.cmliussss.com", name: "Cloudflare CDN" },
    { url: "https://fastly.blog.cmliussss.com", name: "Fastly CDN" },
    { url: "https://gcore.blog.cmliussss.com", name: "Gcore CDN" },
    { url: "https://vercel.blog.cmliussss.com", name: "Vercel CDN" },
    { url: "https://xn--1uto7rutmzjk.us.kg", name: "备用地址" }
  ];

  const timeout = 3000;

  // 测试延迟
  async function testLatency(url) {
    try {
      const start = Date.now();
      const res = await fetch(url, { method: 'HEAD', cf: { cacheTtl: 0 }, timeout: timeout });
      if (res.ok) {
        return Date.now() - start;
      }
      return null; // 请求失败
    } catch (err) {
      return null; // 请求失败
    }
  }

  // 获取延迟最小的URL
  const results = await Promise.all(urls.map(async ({ url, name }) => {
    const latency = await testLatency(url);
    return { url, name, latency };
  }));

  const validResults = results.filter(result => result.latency !== null);
  if (validResults.length > 0) {
    const fastest = validResults.reduce((prev, current) => (prev.latency < current.latency ? prev : current), validResults[0]);

    // 返回HTML页面内容
    return new Response(htmlPage(fastest), {
      headers: { 'Content-Type': 'text/html; charset=UTF-8' }
    });
  }

  return new Response('所有CDN均不可用，请稍后再试。', { status: 503 });
}

// 生成HTML页面
function htmlPage(fastest) {
  return `
  <!DOCTYPE html>
  <html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CM Liussss Blog - CDN 智能访问网关</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #42a5f5, #2962ff);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .container {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 40px;
        width: 450px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .logo-container {
        width: 120px;
        height: 120px;
        margin-bottom: 20px;
        border-radius: 50%;
        overflow: hidden;
        border: 5px solid #fff;
      }
      .logo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        animation: blink 0.5s infinite alternate;
      }
      .status-dot {
        width: 20px;
        height: 20px;
        background-color: #4caf50;
        border-radius: 50%;
        position: absolute;
        bottom: 10px;
        right: 10px;
      }
      @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
      h1 {
        color: #333;
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 20px;
      }
      .description {
        font-size: 16px;
        color: #777;
        margin-bottom: 20px;
        line-height: 1.5;
      }
      .url-item {
        margin: 10px 0;
        font-size: 14px;
        color: #555;
      }
      .latency {
        font-weight: bold;
      }
      .fastest {
        color: #4caf50;
      }
      .status {
        font-size: 12px;
        color: #f44336;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo-container">
        <img class="logo" src="https://raw.cmliussss.com/IMG_0038.png" alt="Logo">
        <div class="status-dot"></div>
      </div>
      <h1>BlogCDN 智能访问网关</h1>
      <div class="description">
        快速访问我们提供的CDN节点，检测延迟并自动跳转至最快的节点。
      </div>
      <ul id="urls">
        ${generateUrlsHtml()}
      </ul>
      <div class="status">
        📢 今日访问人数：<span id="visitCount">加载中...</span>
      </div>
    </div>

    <script>
      // 防止开发者工具被打开
      let devtools = /./;
      devtools.toString = function () {
        alert("开发者工具已禁用！");
        window.location = "https://your-site.com"; // 可以重定向到其他页面
      };
      console.log(devtools);

      // 动态生成URL列表
      const urls = [
        { url: "https://blog.cmliussss.com", name: "Cloudflare CDN" },
        { url: "https://fastly.blog.cmliussss.com", name: "Fastly CDN" },
        { url: "https://gcore.blog.cmliussss.com", name: "Gcore CDN" },
        { url: "https://vercel.blog.cmliussss.com", name: "Vercel CDN" },
        { url: "https://xn--1uto7rutmzjk.us.kg", name: "备用地址" }
      ];

      const ul = document.getElementById("urls");
      urls.forEach((url, index) => {
        const li = document.createElement("li");
        li.classList.add("url-item");
        li.innerHTML = `${url.name} <span class="latency" id="latency${index}">测速中...</span>`;
        ul.appendChild(li);
      });

      async function testLatency(url) {
        const start = Date.now();
        try {
          const res = await fetch(url, { method: 'HEAD' });
          if (res.ok) {
            return Date.now() - start;
          }
        } catch (err) {
          // Handle fetch error
        }
        return null;
      }

      async function runTests() {
        const results = await Promise.all(urls.map(async ({ url, name }, index) => {
          const latency = await testLatency(url);
          const latencyText = latency !== null ? `${latency}ms` : '请求失败';
          const latencyColor = latency !== null ? (latency <= 100 ? '#4caf50' : latency <= 500 ? '#ff9800' : '#f44336') : '#f44336';
          document.getElementById(\`latency\${index}\`).innerText = latencyText;
          document.getElementById(\`latency\${index}\`).style.color = latencyColor;
          return { url, name, latency };
        }));

        const fastest = results.reduce((prev, current) => (prev.latency < current.latency ? prev : current), results[0]);
        document.getElementById('urls').innerHTML += \`<li class="fastest">${fastest.name} (最快)</li>\`;

        // 重定向到最快的URL
        window.location.href = "${fastest.url}";
      }

      window.onload = runTests;
    </script>
  </body>
  </html>
  `;
}

function generateUrlsHtml() {
  const urls = [
    { name: "Cloudflare CDN", url: "https://blog.cmliussss.com" },
    { name: "Fastly CDN", url: "https://fastly.blog.cmliussss.com" },
    { name: "Gcore CDN", url: "https://gcore.blog.cmliussss.com" },
    { name: "Vercel CDN", url: "https://vercel.blog.cmliussss.com" },
    { name: "备用地址", url: "https://xn--1uto7rutmzjk.us.kg" }
  ];

  return urls.map((url, index) => {
    return `<li class="url-item">${url.name} <span class="latency" id="latency${index}">测速中...</span></li>`;
  }).join('');
}
